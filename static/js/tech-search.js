/**
 * Global Tech Search System - Pagefind + Cmd+K Modal
 */

(function() {
    'use strict';

    // State
    let pagefind = null;
    let isInitialized = false;
    let isInitializing = false;
    let searchTimeout = null;
    let selectedIndex = -1;
    let isModalOpen = false;

    // DOM Elements
    const triggerBtn = document.getElementById('techSearchTrigger');
    const modal = document.getElementById('techSearchModal');
    const backdrop = document.getElementById('techSearchBackdrop');
    const closeBtn = document.getElementById('techSearchClose');
    const searchInput = document.getElementById('globalSearchInput');
    const searchResults = document.getElementById('searchResults');
    const searchEmpty = document.getElementById('searchEmpty');
    const searchLoading = document.getElementById('searchLoading');

    // Configuration
    const config = {
        debounceMs: 150,
        maxResults: 15,
        minQueryLength: 2
    };

    /**
     * Initialize Pagefind search engine
     */
    async function initSearch() {
        if (isInitialized || isInitializing) return;
        isInitializing = true;

        try {
            // Dynamically import pagefind generated by the build step
            const baseUrl = document.querySelector('base')?.href || '/';
            pagefind = await import(baseUrl + "pagefind/pagefind.js");
            await pagefind.init();
            isInitialized = true;
            isInitializing = false;
            
            // If there's already a query waiting, search it
            if (searchInput.value.trim().length >= config.minQueryLength) {
                performSearch(searchInput.value.trim());
            } else {
                searchLoading.style.display = 'none';
                searchEmpty.style.display = 'flex';
            }
        } catch (error) {
            console.error('Pagefind initialized failed. Did you run `npx pagefind --site public`?', error);
            isInitializing = false;
            searchLoading.style.display = 'none';
            searchEmpty.innerHTML = `
                <p>Search index not found</p>
                <span class="tech-search-hint">Ensure pagefind has been run on the built site</span>
            `;
            searchEmpty.style.display = 'flex';
        }
    }

    /**
     * Perform pagefind search
     */
    async function performSearch(query) {
        if (!query || query.length < config.minQueryLength) {
            showEmptyState();
            return;
        }

        if (!isInitialized) {
            searchEmpty.style.display = 'none';
            searchLoading.style.display = 'flex';
            searchResults.innerHTML = '';
            initSearch();
            return;
        }

        searchEmpty.style.display = 'none';
        searchLoading.style.display = 'flex';
        searchResults.innerHTML = '';

        try {
            const search = await pagefind.search(query);
            // Limit results early
            const limitedResults = search.results.slice(0, config.maxResults);
            
            if (limitedResults.length === 0) {
                showNoResults(query);
                return;
            }

            // Load data for top results concurrently
            const resultData = await Promise.all(limitedResults.map(r => r.data()));
            displayResults(resultData, query);
        } catch (error) {
            console.error('Search error:', error);
            showNoResults(query);
        }
    }

    /**
     * Display mapped results
     */
    function displayResults(dataItems, query) {
        selectedIndex = -1;
        searchLoading.style.display = 'none';

        if (dataItems.length === 0) {
            showNoResults(query);
            return;
        }

        const html = dataItems.map((item, index) => {
            // Pagefind returns title, url, excerpt, and meta (like date)
            const title = item.meta?.title || item.url || 'Untitled';
            const excerpt = item.excerpt || '';
            const tag = item.meta?.categories || item.meta?.tags || 'Article';

            return `
                <a href="${item.url}" class="tech-search-item" data-index="${index}">
                    <svg class="tech-search-item-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <div class="tech-search-item-content">
                        <div class="tech-search-item-title">${title}</div>
                        <div class="tech-search-item-excerpt">${excerpt}</div>
                        <div class="tech-search-item-meta">
                            <span class="tech-search-item-tag">${tag}</span>
                        </div>
                    </div>
                </a>
            `;
        }).join('');

        searchResults.innerHTML = html;
        searchEmpty.style.display = 'none';
    }

    /**
     * Show empty state
     */
    function showEmptyState() {
        searchLoading.style.display = 'none';
        searchResults.innerHTML = '';
        searchEmpty.style.display = 'flex';
        searchEmpty.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <p>Type to search...</p>
            <span class="tech-search-hint">Powered by Pagefind</span>
        `;
    }

    /**
     * Show no results state
     */
    function showNoResults(query) {
        searchLoading.style.display = 'none';
        searchResults.innerHTML = '';
        searchEmpty.style.display = 'flex';
        searchEmpty.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <p>No results found for "${escapeHtml(query)}"</p>
            <span class="tech-search-hint">Try different keywords</span>
        `;
    }

    /**
     * Update selected item
     */
    function updateSelection(index) {
        const items = searchResults.querySelectorAll('.tech-search-item');
        items.forEach(item => item.classList.remove('selected'));

        if (index >= 0 && index < items.length) {
            selectedIndex = index;
            items[index].classList.add('selected');
            items[index].scrollIntoView({ block: 'nearest' });
        }
    }

    /**
     * Open selected result
     */
    function openSelected() {
        const items = searchResults.querySelectorAll('.tech-search-item');
        if (selectedIndex >= 0 && selectedIndex < items.length) {
            items[selectedIndex].click();
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /* === Modal Controls === */
    function openModal() {
        isModalOpen = true;
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden'; // prevent background scrolling
        
        // Timeout ensures focus works after transition starts
        setTimeout(() => {
            searchInput.focus();
        }, 100);

        if (!isInitialized && !isInitializing) {
            initSearch();
        }
    }

    function closeModal() {
        isModalOpen = false;
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        searchInput.blur();
    }

    /**
     * Event Listeners
     */
     
    // Trigger button clicks
    triggerBtn?.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);
    backdrop?.addEventListener('click', closeModal);

    // Input typing
    searchInput?.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, config.debounceMs);
    });

    // Keyboard navigation
    searchInput?.addEventListener('keydown', (e) => {
        const items = searchResults.querySelectorAll('.tech-search-item');

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                updateSelection(Math.min(selectedIndex + 1, items.length - 1));
                break;

            case 'ArrowUp':
                e.preventDefault();
                updateSelection(Math.max(selectedIndex - 1, -1));
                break;

            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0) {
                    openSelected();
                }
                break;
        }
    });

    // Global keyboard shortcut (Cmd+K / Ctrl+K or /)
    document.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const cmdKey = isMac ? e.metaKey : e.ctrlKey;
        
        // Cmd+K
        if (cmdKey && e.key === 'k') {
            e.preventDefault();
            if (isModalOpen) {
                closeModal();
            } else {
                openModal();
            }
        }
        
        // Escape closes modal
        if (e.key === 'Escape' && isModalOpen) {
            e.preventDefault();
            closeModal();
        }
        
        // / opens modal if not in input
        if (e.key === '/' && !cmdKey && !isModalOpen) {
            const isInputFocused = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);
            if (!isInputFocused) {
                e.preventDefault();
                openModal();
            }
        }
    });

})();
